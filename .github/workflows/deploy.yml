name: Uni-App H5 å…¨è‡ªåŠ¨ç¼–è¯‘éƒ¨ç½²

# å½“æŽ¨é€åˆ° main åˆ†æ”¯æ—¶è§¦å‘
on:
  push:
    branches: [ "main" ]

# èµ‹äºˆå·¥ä½œæµè¯»å†™æƒé™
permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      # æ­¥éª¤1ï¼šä¸‹è½½ä½ çš„æºç 
      - name: Checkout code
        uses: actions/checkout@v4

      # æ­¥éª¤2ï¼šè®¾ç½® Node.js çŽ¯å¢ƒï¼ˆç¼–è¯‘éœ€è¦ï¼‰
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      # æ­¥éª¤3ï¼šå®‰è£…ä¾èµ–ï¼ˆå¦‚æžœæ²¡æœ‰ package.jsonï¼Œè¿™ä¸€æ­¥ä¼šè‡ªåŠ¨è·³è¿‡ï¼‰
      - name: Install dependencies
        run: |
          if [ -f package.json ]; then
            npm install
          fi

      # æ­¥éª¤4ï¼šðŸ”´ å…³é”®ï¼å®‰è£… HBuilderX å‘½ä»¤è¡Œå·¥å…·
      - name: Install HBuilderX CLI
        run: npm install -g @dcloudio/uni-cli

	  # æ­¥éª¤5ï¼šðŸ”´ å…³é”®ï¼åœ¨äº‘ç«¯è‡ªåŠ¨ç¼–è¯‘
	  - name: Build H5 project
	    run: |
		  echo "å¼€å§‹ç¼–è¯‘ H5 é¡¹ç›®..."
		  # å°è¯•å‡ ç§ä¸åŒçš„ç¼–è¯‘å‘½ä»¤
		  if npx --no-install @dcloudio/uni-cli -v &> /dev/null; then
		    npx @dcloudio/uni-cli build --platform h5
		  elif [ -f "package.json" ]; then
		    npm run build:h5 || npm run build
		  else
		    echo "æ— æ³•ç¡®å®šç¼–è¯‘å‘½ä»¤ï¼Œè¯·æ£€æŸ¥é¡¹ç›®é…ç½®"
		    exit 1
		  fi
		  echo "ç¼–è¯‘å®Œæˆï¼Œæ£€æŸ¥è¾“å‡ºç›®å½•..."
		  ls -la dist/build/h5 2>/dev/null || ls -la unpackage/dist/build/web 2>/dev/null || echo "æœªæ‰¾åˆ°ç¼–è¯‘è¾“å‡ºç›®å½•"

      # æ­¥éª¤6ï¼šåˆ›å»º .nojekyll æ–‡ä»¶ï¼ˆå‘Šè¯‰ GitHub ä¸è¦å¤„ç† Jekyllï¼‰
      - name: Create .nojekyll
        run: |
          # å…ˆç¡®è®¤ç¼–è¯‘è¾“å‡ºç›®å½•
          if [ -d "dist/build/h5" ]; then
            touch dist/build/h5/.nojekyll
            DEPLOY_FOLDER="dist/build/h5"
          elif [ -d "unpackage/dist/build/web" ]; then
            touch unpackage/dist/build/web/.nojekyll
            DEPLOY_FOLDER="unpackage/dist/build/web"
          else
            echo "æ— æ³•æ‰¾åˆ°ç¼–è¯‘è¾“å‡ºç›®å½•ï¼"
            exit 1
          fi
          echo "DEPLOY_FOLDER=$DEPLOY_FOLDER" >> $GITHUB_ENV

      # æ­¥éª¤7ï¼šéƒ¨ç½²åˆ° gh-pages åˆ†æ”¯
      - name: Deploy to GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: ${{ env.DEPLOY_FOLDER }}  # ä½¿ç”¨ä¸Šä¸€æ­¥ç¡®å®šçš„ç›®å½•
          branch: gh-pages
          clean: true