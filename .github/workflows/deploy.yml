name: Uni-App H5 自动部署

# 当推送到 main 分支时触发这个工作流
on:
  push:
    branches: [ "main" ]

# 赋予工作流读写仓库内容的权限，这样才能推送代码
permissions:
  contents: write

jobs:
  build-and-deploy:
    # 在最新的 Ubuntu 系统上运行
    runs-on: ubuntu-latest

    steps:
      # 步骤1：把你的代码下载到云端的机器上
      - name: Checkout code
        uses: actions/checkout@v4

      # 步骤2：设置 Node.js 环境
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      # 步骤3：安装依赖
      - name: Install dependencies
        run: npm install

      # 步骤4：安装 HBuilderX 命令行工具
      - name: Install HBuilderX CLI
        run: |
          wget -q https://download.dcloud.net.cn/HBuilderX.4.0.3.20240408.zip -O HBuilderX.zip
          unzip -q HBuilderX.zip -d HBuilderX
          chmod +x HBuilderX/HBuilderX
          echo "HBuilderX installed successfully"

      # 步骤5：编译 Uni-App 项目为 H5
      - name: Build H5 project
        run: |
          # 使用 HBuilderX 命令行工具编译项目
          # 注意：这需要项目中有正确的 manifest.json 配置
          ./HBuilderX/HBuilderX --headless --compile --project . --platform web
          echo "Project built successfully"

      # 步骤6：复制 .nojekyll 文件到编译输出目录
      # 这样 .nojekyll 文件就会被部署到 gh-pages 分支，禁用 GitHub Pages 的默认构建
      - name: Copy .nojekyll file
        run: |
          if [ -f ".nojekyll" ]; then
            cp .nojekyll unpackage/dist/build/web/
          else
            echo ".nojekyll file not found, creating it..."
            touch unpackage/dist/build/web/.nojekyll
          fi

      # 步骤7：部署到 gh-pages 分支
      - name: Deploy to GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: unpackage/dist/build/web   # 指定你的编译输出文件夹
          branch: gh-pages                    # 推送到 gh-pages 分支
          clean: true                          # 部署前先清理 gh-pages 分支的旧文件